<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Encuesta</title>
  <style>
    html, body { margin:0; padding:0; height:100%; }
    body { font-family: system-ui, Arial, sans-serif; }

    #topbar{
      padding:12px 14px;
      text-align:center;
      background:#f7f7f7;
      border-bottom:1px solid #e5e5e5;
      font-size:14px;
    }

    #msg{
      padding:16px;
      text-align:center;
    }

    iframe { width:100%; height:calc(100vh - 48px); border:0; display:none; }

    #overlay{
      position:fixed; inset:0; display:none;
      background:rgba(0,0,0,.78); color:#fff;
      padding:24px; z-index:9999;
      text-align:center;
    }
    #overlay h2{ margin:0 0 10px; }
    #overlay p{ margin:0 0 14px; line-height:1.4; }
    #overlay button{
      padding:12px 16px; border:0; border-radius:10px;
      cursor:pointer; font-weight:700;
    }
  </style>
</head>

<body>
  <div id="topbar">Validando acceso…</div>

  <div id="overlay">
    <h2>Fuera del área permitida</h2>
    <p>
      Detectamos que saliste del perímetro autorizado.<br>
      Debes volver a escanear el QR en el punto autorizado para continuar.
    </p>
    <button onclick="location.replace('/')">Volver a inicio</button>
  </div>

  <div id="msg">Validando acceso…</div>
  <iframe id="formsFrame" src="" allow="geolocation *"></iframe>

<script>
/**
 * CONFIG
 */
const RECHECK_MS = 60_000; // 1 minuto

const FORM_URL = "https://forms.office.com/pages/responsepage.aspx?id=phunyhs3akmGvKPvvktvmxNRWgTyZ2VAuDflhEb8kKNUMkc5OEs0WjM3QVU4OEdTUzJJSDZMSEI4WS4u&origin=lprLink&route=shorturl";

/**
 * UI
 */
const topbar = document.getElementById("topbar");
const msg = document.getElementById("msg");
const frame = document.getElementById("formsFrame");
const overlay = document.getElementById("overlay");

let intervalId = null;

// ⏱️ para el “reloj” (cuenta regresiva)
let countdownId = null;
let secondsLeft = Math.floor(RECHECK_MS / 1000);
let lastDistanceText = "OK";

/**
 * Utilidad: formatea mm:ss
 */
function fmtTime(sec){
  const m = String(Math.floor(sec / 60)).padStart(2, "0");
  const s = String(sec % 60).padStart(2, "0");
  return `${m}:${s}`;
}

function renderTopbar(){
  topbar.textContent = `Acceso permitido · Revalidación en ${fmtTime(secondsLeft)} · Distancia: ${lastDistanceText}`;
}

function startCountdown(){
  stopCountdown();
  secondsLeft = Math.floor(RECHECK_MS / 1000);
  renderTopbar();

  countdownId = setInterval(() => {
    secondsLeft = Math.max(0, secondsLeft - 1);
    renderTopbar();
  }, 1000);
}

function stopCountdown(){
  if(countdownId){
    clearInterval(countdownId);
    countdownId = null;
  }
}

/**
 * Bloqueo total
 */
function lock(reasonText){
  topbar.textContent = reasonText || "Acceso bloqueado";
  msg.textContent = "";
  frame.src = "";
  frame.style.display = "none";
  overlay.style.display = "block";
  if(intervalId) clearInterval(intervalId);
  stopCountdown();
}

/**
 * Valida token + GPS
 */
async function validateTokenAndGPS(token){
  const r = await fetch(`/.netlify/functions/validate?token=${encodeURIComponent(token)}`, {
    cache: "no-store"
  });
  return await r.json();
}

async function start(){
  const params = new URLSearchParams(location.search);
  const token = params.get("token");

  if(!token){
    location.replace("/");
    return;
  }

  try{
    msg.textContent = "Validando acceso…";
    topbar.textContent = "Validando acceso…";

    // 1) Validación inicial
    const first = await validateTokenAndGPS(token);
    if(!first || !first.ok){
      return lock("Fuera del área permitida");
    }

    // 2) Acceso permitido
    lastDistanceText = (typeof first.distance_m === "number")
      ? `${Math.round(first.distance_m)} m`
      : "OK";

    msg.textContent = "";
    frame.src = FORM_URL;
    frame.style.display = "block";

    // Quitar token de la barra
    history.replaceState({}, "", "/form.html");

    // 3) Iniciar “reloj” regresivo
    startCountdown();

    // 4) Revalidación cada 1 minuto
    intervalId = setInterval(async () => {
      try{
        const v = await validateTokenAndGPS(token);

        if(!v || !v.ok){
          return lock("Fuera del área permitida");
        }

        lastDistanceText = (typeof v.distance_m === "number")
          ? `${Math.round(v.distance_m)} m`
          : "OK";

        // reinicia el reloj cuando revalida
        startCountdown();

      }catch(e){
        lock("No se pudo revalidar ubicación");
      }
    }, RECHECK_MS);

  }catch(e){
    lock("No se pudo validar acceso");
  }
}

start();
</script>
</body>
</html>




